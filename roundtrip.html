<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-99.9.9">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">

<meta name="dcterms.date" content="2025-03-31">
<meta name="description" content="This notebook demonstrates the full pipeline for validating color fidelity when converting EXR image sequences through ProRes 4444 roundtrip compression. It is designed to teach: - Pattern generation (RGB ramps, ColorChecker) - Codec roundtrip testing with ffmpeg - Use of oiiotool for conversion and analysis - Difference visualization and metrics (RMS, PSNR, Max error)">

<title>EXR Roundtrip Codec Validation</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for syntax highlighting */
html { -webkit-text-size-adjust: 100%; }
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
</style>


<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.5.1/jquery.min.js" integrity="sha512-bLT0Qm9VnAYZDflyKcBaQ2gg0hSYNQrJ8RilYldYQ1FxQYoCLtUjuuRuZo+fjqhx/qtq/1itJ0C2ejDxltZVFg==" crossorigin="anonymous"></script><script src="roundtrip_files/libs/clipboard/clipboard.min.js"></script>
<script src="roundtrip_files/libs/quarto-html/quarto.js" type="module"></script>
<script src="roundtrip_files/libs/quarto-html/tabsets/tabsets.js" type="module"></script>
<script src="roundtrip_files/libs/quarto-html/popper.min.js"></script>
<script src="roundtrip_files/libs/quarto-html/tippy.umd.min.js"></script>
<script src="roundtrip_files/libs/quarto-html/anchor.min.js"></script>
<link href="roundtrip_files/libs/quarto-html/tippy.css" rel="stylesheet">
<link href="roundtrip_files/libs/quarto-html/quarto-syntax-highlighting-494121dfa8658343c03537e94414993d.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="roundtrip_files/libs/bootstrap/bootstrap.min.js"></script>
<link href="roundtrip_files/libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="roundtrip_files/libs/bootstrap/bootstrap-c73da311dcb4b46904599e04e07723a5.min.css" rel="stylesheet" append-hash="true" id="quarto-bootstrap" data-mode="light">
<style>

      .quarto-title-block .quarto-title-banner h1,
      .quarto-title-block .quarto-title-banner h2,
      .quarto-title-block .quarto-title-banner h3,
      .quarto-title-block .quarto-title-banner h4,
      .quarto-title-block .quarto-title-banner h5,
      .quarto-title-block .quarto-title-banner h6
      {
        color: #F0F3F4;
      }

      .quarto-title-block .quarto-title-banner {
        color: #F0F3F4;
background: #F76902;
      }
</style>
<script src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.6/require.min.js" integrity="sha512-c3Nl8+7g4LMSTdrm621y7kf9v3SDPnhxLNhcjFJbKECVnmZHTdo+IRO05sNLTH/D3vA6u1X32ehoLC7WFVdheg==" crossorigin="anonymous"></script>

<script type="application/javascript">define('jquery', [],function() {return window.jQuery;})</script>


<link rel="stylesheet" href="styles.css">
</head>

<body class="quarto-light">

<header id="title-block-header" class="quarto-title-block default toc-left page-columns page-full">
  <div class="quarto-title-banner page-columns page-full">
    <div class="quarto-title column-body">
      <h1 class="title">EXR Roundtrip Codec Validation</h1>
          </div>

    
    <div class="quarto-title-meta-container">
      <div class="quarto-title-meta-column-start">
            <div class="quarto-title-meta-author">
          <div class="quarto-title-meta-heading">Author</div>
          <div class="quarto-title-meta-heading">Affiliation</div>
          
                <div class="quarto-title-meta-contents">
            <p class="author">Prof.&nbsp;Flip Phillips, Ph.D. </p>
          </div>
                <div class="quarto-title-meta-contents">
                    <p class="affiliation">
                        Rochester Institute of Technology, MAGIC, MPS, CIS
                      </p>
                  </div>
                    </div>
        
        <div class="quarto-title-meta">

                      
                <div>
            <div class="quarto-title-meta-heading">Published</div>
            <div class="quarto-title-meta-contents">
              <p class="date">March 31, 2025</p>
            </div>
          </div>
          
                
              </div>
      </div>
      <div class="quarto-title-meta-column-end quarto-other-formats-target">
      </div>
    </div>



    <div class="quarto-other-links-text-target">
    </div>  </div>
</header><div id="quarto-content" class="page-columns page-rows-contents page-layout-article toc-left">
<div id="quarto-sidebar-toc-left" class="sidebar toc-left">
  <nav id="TOC" role="doc-toc" class="toc-active">
    <h2 id="toc-title">Table of contents</h2>
   
  <ul>
  <li><a href="#overview" id="toc-overview" class="nav-link active" data-scroll-target="#overview">📖 Overview</a></li>
  <li><a href="#frame-generation" id="toc-frame-generation" class="nav-link" data-scroll-target="#frame-generation">📦 Frame Generation</a>
  <ul class="collapse">
  <li><a href="#red-green-blue-test-frames" id="toc-red-green-blue-test-frames" class="nav-link" data-scroll-target="#red-green-blue-test-frames">🔴 Red / 🟢 Green / 🔵 Blue Test Frames</a></li>
  <li><a href="#colorchecker-from-tiff" id="toc-colorchecker-from-tiff" class="nav-link" data-scroll-target="#colorchecker-from-tiff">🎨 ColorChecker from TIFF</a></li>
  <li><a href="#generate-ramps-via-python" id="toc-generate-ramps-via-python" class="nav-link" data-scroll-target="#generate-ramps-via-python">📈 Generate Ramps via Python</a></li>
  <li><a href="#encode-to-prores-hq" id="toc-encode-to-prores-hq" class="nav-link" data-scroll-target="#encode-to-prores-hq">🎞️ Encode to ProRes HQ</a></li>
  <li><a href="#decode-to-tiffs-convert-to-linear-exrs" id="toc-decode-to-tiffs-convert-to-linear-exrs" class="nav-link" data-scroll-target="#decode-to-tiffs-convert-to-linear-exrs">📥 Decode to TIFFs, Convert to Linear EXRs</a></li>
  <li><a href="#compute-differences-export-heatmaps" id="toc-compute-differences-export-heatmaps" class="nav-link" data-scroll-target="#compute-differences-export-heatmaps">🔎 Compute Differences &amp; Export Heatmaps</a></li>
  </ul></li>
  <li><a href="#we-now-have-fully-traceable-artifacts-for-visual-and-statistical-inspection." id="toc-we-now-have-fully-traceable-artifacts-for-visual-and-statistical-inspection." class="nav-link" data-scroll-target="#we-now-have-fully-traceable-artifacts-for-visual-and-statistical-inspection.">We now have fully traceable artifacts for visual and statistical inspection.</a></li>
  <li><a href="#diff-metrics-and-heatmaps" id="toc-diff-metrics-and-heatmaps" class="nav-link" data-scroll-target="#diff-metrics-and-heatmaps">🔎 Diff Metrics and Heatmaps</a>
  <ul class="collapse">
  <li><a href="#error-vs-frame" id="toc-error-vs-frame" class="nav-link" data-scroll-target="#error-vs-frame">📈 Error vs Frame</a></li>
  </ul></li>
  <li><a href="#visual-comparison" id="toc-visual-comparison" class="nav-link" data-scroll-target="#visual-comparison">🌈 Visual Comparison</a>
  <ul class="collapse">
  <li><a href="#difference-maps" id="toc-difference-maps" class="nav-link" data-scroll-target="#difference-maps">🔥 Difference Maps</a></li>
  </ul></li>
  <li><a href="#notes-for-students" id="toc-notes-for-students" class="nav-link" data-scroll-target="#notes-for-students">🧪 Notes for Students</a></li>
  <li><a href="#artifacts" id="toc-artifacts" class="nav-link" data-scroll-target="#artifacts">📁 Artifacts</a></li>
  <li><a href="#wrap-up" id="toc-wrap-up" class="nav-link" data-scroll-target="#wrap-up">✅ Wrap-up</a></li>
  </ul>
</nav>
</div>
<div id="quarto-margin-sidebar" class="sidebar margin-sidebar zindex-bottom">
</div>
<main class="content quarto-banner-title-block" id="quarto-document-content">



  


<section id="overview" class="level2">
<h2 class="anchored" data-anchor-id="overview">📖 Overview</h2>
<p>This notebook provides a comprehensive guide to validating the fidelity of EXR image sequences when encoded and decoded through ProRes 4444. It covers the entire pipeline from generating test frames, encoding them, decoding back to EXR, and analyzing the differences.</p>
<p>The goal is to ensure that the roundtrip process maintains the original image quality, which is crucial for visual effects and animation workflows.</p>
<p>This workflow requires: - <strong>Python 3.8+</strong> with <code>numpy</code>, <code>pandas</code>, <code>matplotlib</code>, and <code>seaborn</code> - <strong>OpenColorIO</strong> for color management - <strong>OpenImageIO</strong> for image processing - <strong>ImageMagick</strong> for TIFF conversion - <strong>FFmpeg</strong> for video encoding/decoding - <strong>oiiotool</strong> for image manipulation and analysis</p>
</section>
<section id="frame-generation" class="level2">
<h2 class="anchored" data-anchor-id="frame-generation">📦 Frame Generation</h2>
<p>We will now generate a suite of test frames for evaluating codec roundtrip fidelity.</p>
<p>Note that there is a <code>gentests.sh</code> script that can be run to generate all the test frames and perform the roundtrip codec validation. This script is designed to be run in a Unix-like environment (Linux, macOS, WSL on Windows).</p>
<p>Here, we will break down the steps to generate the test frames and perform the roundtrip codec validation via some Python glue.</p>
<section id="red-green-blue-test-frames" class="level3">
<h3 class="anchored" data-anchor-id="red-green-blue-test-frames">🔴 Red / 🟢 Green / 🔵 Blue Test Frames</h3>
<p>Just some full frames of red, green, and blue to start with. Use <code>oiiotool</code> to generate these frames.</p>
<p>We’ll create a directory called <code>test_frames</code> to store all the generated frames.</p>
<p>In python cells, you can use an exclaimation mark <code>!</code> to run shell commands. This is useful for running <code>oiiotool</code>, <code>ffmpeg</code>, and other command-line tools directly from the notebook.</p>
<div id="b4f92c7e" class="cell" data-execution_count="1">
<div class="sourceCode cell-code" id="cb1"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> os</span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-3"><a href="#cb1-3" aria-hidden="true" tabindex="-1"></a><span class="co"># Create a directory for test frames - </span></span>
<span id="cb1-4"><a href="#cb1-4" aria-hidden="true" tabindex="-1"></a><span class="co"># we use this later too</span></span>
<span id="cb1-5"><a href="#cb1-5" aria-hidden="true" tabindex="-1"></a>test_frames_dir <span class="op">=</span> <span class="st">"test_frames"</span></span>
<span id="cb1-6"><a href="#cb1-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-7"><a href="#cb1-7" aria-hidden="true" tabindex="-1"></a>os.makedirs(test_frames_dir, exist_ok<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb1-8"><a href="#cb1-8" aria-hidden="true" tabindex="-1"></a>os.chdir(test_frames_dir)</span>
<span id="cb1-9"><a href="#cb1-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-10"><a href="#cb1-10" aria-hidden="true" tabindex="-1"></a><span class="co"># Generate RGB test frames</span></span>
<span id="cb1-11"><a href="#cb1-11" aria-hidden="true" tabindex="-1"></a><span class="op">!</span>oiiotool <span class="op">--</span>pattern constant:<span class="dv">2048</span><span class="er">x1536</span>:<span class="dv">3</span> <span class="dv">2048</span><span class="er">x1536</span> <span class="dv">3</span> <span class="op">--</span>chnames R,G,B <span class="op">--</span>ch R<span class="op">=</span><span class="dv">1</span>,G<span class="op">=</span><span class="dv">0</span>,B<span class="op">=</span><span class="dv">0</span> <span class="op">-</span>o frame_0001.exr</span>
<span id="cb1-12"><a href="#cb1-12" aria-hidden="true" tabindex="-1"></a><span class="op">!</span>oiiotool <span class="op">--</span>pattern constant:<span class="dv">2048</span><span class="er">x1536</span>:<span class="dv">3</span> <span class="dv">2048</span><span class="er">x1536</span> <span class="dv">3</span> <span class="op">--</span>chnames R,G,B <span class="op">--</span>ch R<span class="op">=</span><span class="dv">0</span>,G<span class="op">=</span><span class="dv">1</span>,B<span class="op">=</span><span class="dv">0</span> <span class="op">-</span>o frame_0002.exr</span>
<span id="cb1-13"><a href="#cb1-13" aria-hidden="true" tabindex="-1"></a><span class="op">!</span>oiiotool <span class="op">--</span>pattern constant:<span class="dv">2048</span><span class="er">x1536</span>:<span class="dv">3</span> <span class="dv">2048</span><span class="er">x1536</span> <span class="dv">3</span> <span class="op">--</span>chnames R,G,B <span class="op">--</span>ch R<span class="op">=</span><span class="dv">0</span>,G<span class="op">=</span><span class="dv">0</span>,B<span class="op">=</span><span class="dv">1</span> <span class="op">-</span>o frame_0003.exr</span>
<span id="cb1-14"><a href="#cb1-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-15"><a href="#cb1-15" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"✅ RGB generated in "</span><span class="op">+</span>test_frames_dir)</span>
<span id="cb1-16"><a href="#cb1-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-17"><a href="#cb1-17" aria-hidden="true" tabindex="-1"></a><span class="co"># Change directory back to the original location</span></span>
<span id="cb1-18"><a href="#cb1-18" aria-hidden="true" tabindex="-1"></a>os.chdir(<span class="st">".."</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>✅ RGB generated in test_frames</code></pre>
</div>
</div>
</section>
<section id="colorchecker-from-tiff" class="level3">
<h3 class="anchored" data-anchor-id="colorchecker-from-tiff">🎨 ColorChecker from TIFF</h3>
<p>This goes out to the <a href="https://babelcolor.com/colorchecker-2.htm#CCP2_data">Babel Color site</a> to get their ColorChecker L*a*b* TIFF that has been measured and averaged over multiple charts (30 I think?). We then convert it to EXR using ImageMagick and resize it with <code>oiiotool</code>.<a href="#fn1" class="footnote-ref" id="fnref1" role="doc-noteref"><sup>1</sup></a></p>
<div id="9cf8b170" class="cell" data-execution_count="2">
<div class="sourceCode cell-code" id="cb3"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> urllib.request</span>
<span id="cb3-2"><a href="#cb3-2" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> zipfile</span>
<span id="cb3-3"><a href="#cb3-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-4"><a href="#cb3-4" aria-hidden="true" tabindex="-1"></a><span class="co"># go to the test frames directory</span></span>
<span id="cb3-5"><a href="#cb3-5" aria-hidden="true" tabindex="-1"></a>os.chdir(test_frames_dir) </span>
<span id="cb3-6"><a href="#cb3-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-7"><a href="#cb3-7" aria-hidden="true" tabindex="-1"></a><span class="co"># Define the URL and local paths</span></span>
<span id="cb3-8"><a href="#cb3-8" aria-hidden="true" tabindex="-1"></a>url <span class="op">=</span> <span class="st">"https://babelcolor.com/index_htm_files/ColorChecker_Lab_from_X-Rite_16bit_AfterNov2014.zip"</span></span>
<span id="cb3-9"><a href="#cb3-9" aria-hidden="true" tabindex="-1"></a>zip_path <span class="op">=</span> <span class="st">"ColorChecker_Lab.zip"</span></span>
<span id="cb3-10"><a href="#cb3-10" aria-hidden="true" tabindex="-1"></a>extract_path <span class="op">=</span> <span class="st">"."</span></span>
<span id="cb3-11"><a href="#cb3-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-12"><a href="#cb3-12" aria-hidden="true" tabindex="-1"></a><span class="co"># Download the file if it doesn't exist</span></span>
<span id="cb3-13"><a href="#cb3-13" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> <span class="kw">not</span> os.path.exists(zip_path):</span>
<span id="cb3-14"><a href="#cb3-14" aria-hidden="true" tabindex="-1"></a>  <span class="bu">print</span>(<span class="st">"Downloading ColorChecker Lab ZIP..."</span>)</span>
<span id="cb3-15"><a href="#cb3-15" aria-hidden="true" tabindex="-1"></a>  urllib.request.urlretrieve(url, zip_path)</span>
<span id="cb3-16"><a href="#cb3-16" aria-hidden="true" tabindex="-1"></a><span class="cf">else</span>:</span>
<span id="cb3-17"><a href="#cb3-17" aria-hidden="true" tabindex="-1"></a>  <span class="bu">print</span>(<span class="st">"ZIP file already exists. Skipping download."</span>)</span>
<span id="cb3-18"><a href="#cb3-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-19"><a href="#cb3-19" aria-hidden="true" tabindex="-1"></a><span class="co"># Extract the ZIP file</span></span>
<span id="cb3-20"><a href="#cb3-20" aria-hidden="true" tabindex="-1"></a><span class="cf">with</span> zipfile.ZipFile(zip_path, <span class="st">'r'</span>) <span class="im">as</span> zip_ref:</span>
<span id="cb3-21"><a href="#cb3-21" aria-hidden="true" tabindex="-1"></a>    zip_ref.extractall(extract_path)</span>
<span id="cb3-22"><a href="#cb3-22" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-23"><a href="#cb3-23" aria-hidden="true" tabindex="-1"></a><span class="co"># Do the annoying ImageMagick conversion to EXR - you _should_ be able</span></span>
<span id="cb3-24"><a href="#cb3-24" aria-hidden="true" tabindex="-1"></a><span class="co"># to do this with oiiotool, but it doesn't work for some reason.</span></span>
<span id="cb3-25"><a href="#cb3-25" aria-hidden="true" tabindex="-1"></a><span class="op">!</span>magick ColorChecker_Lab_from_X<span class="op">-</span>Rite_16bit_AfterNov2014.tif <span class="op">\</span></span>
<span id="cb3-26"><a href="#cb3-26" aria-hidden="true" tabindex="-1"></a>  <span class="op">-</span>colorspace sRGB <span class="op">-</span>depth <span class="dv">16</span> <span class="op">-</span>define quantum:<span class="bu">format</span><span class="op">=</span>floating<span class="op">-</span>point <span class="op">\</span></span>
<span id="cb3-27"><a href="#cb3-27" aria-hidden="true" tabindex="-1"></a>  EXR:frame_0004_tmp.exr</span>
<span id="cb3-28"><a href="#cb3-28" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-29"><a href="#cb3-29" aria-hidden="true" tabindex="-1"></a><span class="co"># Resize to 2048x1536 and convert to half-float EXR</span></span>
<span id="cb3-30"><a href="#cb3-30" aria-hidden="true" tabindex="-1"></a><span class="op">!</span>oiiotool frame_0004_tmp.exr <span class="op">--</span>resize <span class="dv">2048</span><span class="er">x1536</span> <span class="op">-</span>d half <span class="op">-</span>o frame_0004.exr</span>
<span id="cb3-31"><a href="#cb3-31" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-32"><a href="#cb3-32" aria-hidden="true" tabindex="-1"></a><span class="co"># Clean up</span></span>
<span id="cb3-33"><a href="#cb3-33" aria-hidden="true" tabindex="-1"></a><span class="co"># Remove temporary files</span></span>
<span id="cb3-34"><a href="#cb3-34" aria-hidden="true" tabindex="-1"></a>os.remove(<span class="st">"frame_0004_tmp.exr"</span>)</span>
<span id="cb3-35"><a href="#cb3-35" aria-hidden="true" tabindex="-1"></a>os.remove(<span class="st">"ColorChecker_Lab_from_X-Rite_16bit_AfterNov2014.tif"</span>)</span>
<span id="cb3-36"><a href="#cb3-36" aria-hidden="true" tabindex="-1"></a>os.remove(<span class="st">"ColorChecker_Lab.zip"</span>)</span>
<span id="cb3-37"><a href="#cb3-37" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-38"><a href="#cb3-38" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"✅ Color Checker downloaded and converted "</span><span class="op">+</span>test_frames_dir)</span>
<span id="cb3-39"><a href="#cb3-39" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-40"><a href="#cb3-40" aria-hidden="true" tabindex="-1"></a><span class="co"># Change directory back to the original location</span></span>
<span id="cb3-41"><a href="#cb3-41" aria-hidden="true" tabindex="-1"></a>os.chdir(<span class="st">".."</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Downloading ColorChecker Lab ZIP...
✅ Color Checker downloaded and converted test_frames</code></pre>
</div>
</div>
</section>
<section id="generate-ramps-via-python" class="level3">
<h3 class="anchored" data-anchor-id="generate-ramps-via-python">📈 Generate Ramps via Python</h3>
<p>There are scripts in the directory that already do these things, but we’ll just drop them in here for conpleteness. It turns out <code>oiiotool</code> used to be able to do this, but it doesn’t work anymore. So we have to use Python to generate the ramps.</p>
<p>The <code>make_quantized_ramp_exr.py</code> script generates a quantized ramp image, while the <code>make_ramp_exr.py</code> script generates a linear ramp image.</p>
<section id="regular-ramp" class="level4">
<h4 class="anchored" data-anchor-id="regular-ramp">Regular Ramp</h4>
<div id="57a49238" class="cell" data-execution_count="3">
<div class="sourceCode cell-code" id="cb5"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb5-1"><a href="#cb5-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> OpenImageIO <span class="im">as</span> oiio</span>
<span id="cb5-2"><a href="#cb5-2" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> numpy <span class="im">as</span> np</span>
<span id="cb5-3"><a href="#cb5-3" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> sys</span>
<span id="cb5-4"><a href="#cb5-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-5"><a href="#cb5-5" aria-hidden="true" tabindex="-1"></a>W, H <span class="op">=</span> <span class="dv">2048</span>, <span class="dv">1536</span></span>
<span id="cb5-6"><a href="#cb5-6" aria-hidden="true" tabindex="-1"></a>ramp <span class="op">=</span> np.linspace(<span class="dv">0</span>, <span class="dv">1</span>, W, dtype<span class="op">=</span>np.float32)</span>
<span id="cb5-7"><a href="#cb5-7" aria-hidden="true" tabindex="-1"></a>ramp_2d <span class="op">=</span> np.tile(ramp, (H, <span class="dv">1</span>))</span>
<span id="cb5-8"><a href="#cb5-8" aria-hidden="true" tabindex="-1"></a>rgb <span class="op">=</span> np.stack([ramp_2d]<span class="op">*</span><span class="dv">3</span>, axis<span class="op">=</span><span class="dv">2</span>)</span>
<span id="cb5-9"><a href="#cb5-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-10"><a href="#cb5-10" aria-hidden="true" tabindex="-1"></a>spec <span class="op">=</span> oiio.ImageSpec(W, H, <span class="dv">3</span>, <span class="st">"float"</span>)</span>
<span id="cb5-11"><a href="#cb5-11" aria-hidden="true" tabindex="-1"></a>buf <span class="op">=</span> oiio.ImageBuf(spec)</span>
<span id="cb5-12"><a href="#cb5-12" aria-hidden="true" tabindex="-1"></a>buf.set_pixels(oiio.ROI(<span class="dv">0</span>, W, <span class="dv">0</span>, H), rgb)</span>
<span id="cb5-13"><a href="#cb5-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-14"><a href="#cb5-14" aria-hidden="true" tabindex="-1"></a>output_filename <span class="op">=</span> test_frames_dir<span class="op">+</span><span class="st">'/frame_0005.exr'</span></span>
<span id="cb5-15"><a href="#cb5-15" aria-hidden="true" tabindex="-1"></a>buf.write(output_filename)</span>
<span id="cb5-16"><a href="#cb5-16" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"✅ Wrote ramp to "</span><span class="op">+</span>output_filename)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>✅ Wrote ramp to test_frames/frame_0005.exr</code></pre>
</div>
</div>
</section>
<section id="quantized-ramp" class="level4">
<h4 class="anchored" data-anchor-id="quantized-ramp">Quantized Ramp</h4>
<p>Same thing as above, but we’re quantizing it to 10-bit to mimic the 4:2:2 ProRes HQ we’re messing with from Kodak’s scanner.</p>
<div id="14c1a57f" class="cell" data-execution_count="4">
<div class="sourceCode cell-code" id="cb7"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb7-1"><a href="#cb7-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> OpenImageIO <span class="im">as</span> oiio</span>
<span id="cb7-2"><a href="#cb7-2" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> numpy <span class="im">as</span> np</span>
<span id="cb7-3"><a href="#cb7-3" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> sys</span>
<span id="cb7-4"><a href="#cb7-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-5"><a href="#cb7-5" aria-hidden="true" tabindex="-1"></a>W, H <span class="op">=</span> <span class="dv">2048</span>, <span class="dv">1536</span></span>
<span id="cb7-6"><a href="#cb7-6" aria-hidden="true" tabindex="-1"></a>levels <span class="op">=</span> <span class="dv">1024</span>  <span class="co"># Simulate 10-bit ProRes quantization</span></span>
<span id="cb7-7"><a href="#cb7-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-8"><a href="#cb7-8" aria-hidden="true" tabindex="-1"></a><span class="co"># Create a quantized horizontal ramp</span></span>
<span id="cb7-9"><a href="#cb7-9" aria-hidden="true" tabindex="-1"></a>ramp <span class="op">=</span> np.linspace(<span class="dv">0</span>, <span class="dv">1</span>, levels, endpoint<span class="op">=</span><span class="va">True</span>, dtype<span class="op">=</span>np.float32)</span>
<span id="cb7-10"><a href="#cb7-10" aria-hidden="true" tabindex="-1"></a>ramp <span class="op">=</span> np.repeat(ramp, W <span class="op">//</span> levels <span class="op">+</span> <span class="dv">1</span>)[:W]  <span class="co"># Extend to W pixels</span></span>
<span id="cb7-11"><a href="#cb7-11" aria-hidden="true" tabindex="-1"></a>ramp_2d <span class="op">=</span> np.tile(ramp, (H, <span class="dv">1</span>))</span>
<span id="cb7-12"><a href="#cb7-12" aria-hidden="true" tabindex="-1"></a>rgb <span class="op">=</span> np.stack([ramp_2d] <span class="op">*</span> <span class="dv">3</span>, axis<span class="op">=</span><span class="dv">2</span>)</span>
<span id="cb7-13"><a href="#cb7-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-14"><a href="#cb7-14" aria-hidden="true" tabindex="-1"></a>spec <span class="op">=</span> oiio.ImageSpec(W, H, <span class="dv">3</span>, <span class="st">"float"</span>)</span>
<span id="cb7-15"><a href="#cb7-15" aria-hidden="true" tabindex="-1"></a>buf <span class="op">=</span> oiio.ImageBuf(spec)</span>
<span id="cb7-16"><a href="#cb7-16" aria-hidden="true" tabindex="-1"></a>buf.set_pixels(oiio.ROI(<span class="dv">0</span>, W, <span class="dv">0</span>, H), rgb)</span>
<span id="cb7-17"><a href="#cb7-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-18"><a href="#cb7-18" aria-hidden="true" tabindex="-1"></a>output_filename <span class="op">=</span> test_frames_dir<span class="op">+</span><span class="ss">f'/frame_0006.exr'</span></span>
<span id="cb7-19"><a href="#cb7-19" aria-hidden="true" tabindex="-1"></a>buf.write(output_filename)</span>
<span id="cb7-20"><a href="#cb7-20" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"✅ Wrote quantized ramp to "</span><span class="op">+</span>output_filename)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>✅ Wrote quantized ramp to test_frames/frame_0006.exr</code></pre>
</div>
</div>
<hr>
</section>
</section>
<section id="encode-to-prores-hq" class="level3">
<h3 class="anchored" data-anchor-id="encode-to-prores-hq">🎞️ Encode to ProRes HQ</h3>
<p>Now that we have the test frames, we can encode them to ProRes HQ. This is done using <code>ffmpeg</code>, a powerful tool for video processing. The command below encodes the EXR frames into a ProRes 4444 MOV file. The <code>-pix_fmt yuv444p10le</code> option specifies the pixel format, and <code>-profile:v 4</code> sets the ProRes profile to 4444. If we prefer a 4:2:2 profile, we can use <code>-profile:v 3</code> instead.</p>
<p>Let’s do this with straight python, no bash, for now. This way you can see how to explicitly call the subprocesses if you want. (It also lets us do some variable substitution.)</p>
<div id="1e844e22" class="cell" data-execution_count="5">
<div class="sourceCode cell-code" id="cb9"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb9-1"><a href="#cb9-1" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> subprocess <span class="im">import</span> run</span>
<span id="cb9-2"><a href="#cb9-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-3"><a href="#cb9-3" aria-hidden="true" tabindex="-1"></a>output_file <span class="op">=</span> <span class="ss">f"test_output.mov"</span></span>
<span id="cb9-4"><a href="#cb9-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-5"><a href="#cb9-5" aria-hidden="true" tabindex="-1"></a>run([</span>
<span id="cb9-6"><a href="#cb9-6" aria-hidden="true" tabindex="-1"></a>  <span class="st">"ffmpeg"</span>,</span>
<span id="cb9-7"><a href="#cb9-7" aria-hidden="true" tabindex="-1"></a>  <span class="st">"-hide_banner"</span>, <span class="st">"-loglevel"</span>, <span class="st">"error"</span>, <span class="st">"-y"</span>,</span>
<span id="cb9-8"><a href="#cb9-8" aria-hidden="true" tabindex="-1"></a>  <span class="st">"-r"</span>, <span class="st">"24"</span>,</span>
<span id="cb9-9"><a href="#cb9-9" aria-hidden="true" tabindex="-1"></a>  <span class="st">"-start_number"</span>, <span class="st">"1"</span>,</span>
<span id="cb9-10"><a href="#cb9-10" aria-hidden="true" tabindex="-1"></a>  <span class="st">"-i"</span>, <span class="ss">f"</span><span class="sc">{</span>test_frames_dir<span class="sc">}</span><span class="ss">/frame_%04d.exr"</span>,</span>
<span id="cb9-11"><a href="#cb9-11" aria-hidden="true" tabindex="-1"></a>  <span class="st">"-frames:v"</span>, <span class="st">"6"</span>,</span>
<span id="cb9-12"><a href="#cb9-12" aria-hidden="true" tabindex="-1"></a>  <span class="st">"-c:v"</span>, <span class="st">"prores_ks"</span>,</span>
<span id="cb9-13"><a href="#cb9-13" aria-hidden="true" tabindex="-1"></a>  <span class="st">"-profile:v"</span>, <span class="st">"4"</span>,</span>
<span id="cb9-14"><a href="#cb9-14" aria-hidden="true" tabindex="-1"></a>  <span class="st">"-pix_fmt"</span>, <span class="st">"yuv444p10le"</span>,</span>
<span id="cb9-15"><a href="#cb9-15" aria-hidden="true" tabindex="-1"></a>  output_file</span>
<span id="cb9-16"><a href="#cb9-16" aria-hidden="true" tabindex="-1"></a>])</span>
<span id="cb9-17"><a href="#cb9-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-18"><a href="#cb9-18" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"✅ Wrote movie to "</span><span class="op">+</span>output_file)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>✅ Wrote movie to test_output.mov</code></pre>
</div>
</div>
</section>
<section id="decode-to-tiffs-convert-to-linear-exrs" class="level3">
<h3 class="anchored" data-anchor-id="decode-to-tiffs-convert-to-linear-exrs">📥 Decode to TIFFs, Convert to Linear EXRs</h3>
<p>The ‘clean’ way to do this, according to the FFmpeg documentation, is to dump as TIFFs and then convert to EXRs. This is done using <code>ffmpeg</code> to decode the MOV file back into TIFF frames, and then using <code>oiiotool</code> to convert the TIFFs to EXR format with linear color space.</p>
<p>Again, straight python, because we’re doing some variable substitution.</p>
<div id="0dece44d" class="cell" data-execution_count="6">
<div class="sourceCode cell-code" id="cb11"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb11-1"><a href="#cb11-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> glob</span>
<span id="cb11-2"><a href="#cb11-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-3"><a href="#cb11-3" aria-hidden="true" tabindex="-1"></a><span class="co"># Define paths</span></span>
<span id="cb11-4"><a href="#cb11-4" aria-hidden="true" tabindex="-1"></a>tiff_dir <span class="op">=</span> <span class="st">"tiff_frames"</span></span>
<span id="cb11-5"><a href="#cb11-5" aria-hidden="true" tabindex="-1"></a>exr_dir <span class="op">=</span> <span class="st">"exr_frames"</span></span>
<span id="cb11-6"><a href="#cb11-6" aria-hidden="true" tabindex="-1"></a>ocio_config <span class="op">=</span> <span class="st">"./ocio_rec709_to_linear/config.ocio"</span></span>
<span id="cb11-7"><a href="#cb11-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-8"><a href="#cb11-8" aria-hidden="true" tabindex="-1"></a>os.makedirs(tiff_dir, exist_ok<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb11-9"><a href="#cb11-9" aria-hidden="true" tabindex="-1"></a>os.makedirs(exr_dir, exist_ok<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb11-10"><a href="#cb11-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-11"><a href="#cb11-11" aria-hidden="true" tabindex="-1"></a><span class="co"># Run the ffmpeg command to extract TIFF frames</span></span>
<span id="cb11-12"><a href="#cb11-12" aria-hidden="true" tabindex="-1"></a>run([</span>
<span id="cb11-13"><a href="#cb11-13" aria-hidden="true" tabindex="-1"></a>  <span class="st">"ffmpeg"</span>, </span>
<span id="cb11-14"><a href="#cb11-14" aria-hidden="true" tabindex="-1"></a>  <span class="st">"-hide_banner"</span>, <span class="st">"-loglevel"</span>, <span class="st">"error"</span>, <span class="st">"-y"</span>,</span>
<span id="cb11-15"><a href="#cb11-15" aria-hidden="true" tabindex="-1"></a>  <span class="st">"-i"</span>, <span class="st">"test_output.mov"</span>,</span>
<span id="cb11-16"><a href="#cb11-16" aria-hidden="true" tabindex="-1"></a>  <span class="st">"-pix_fmt"</span>, <span class="st">"rgb48le"</span>,</span>
<span id="cb11-17"><a href="#cb11-17" aria-hidden="true" tabindex="-1"></a>  <span class="st">"-start_number"</span>, <span class="st">"1"</span>,</span>
<span id="cb11-18"><a href="#cb11-18" aria-hidden="true" tabindex="-1"></a>  tiff_dir<span class="op">+</span><span class="st">"/frame_</span><span class="sc">%04d</span><span class="st">.tif"</span></span>
<span id="cb11-19"><a href="#cb11-19" aria-hidden="true" tabindex="-1"></a>])</span>
<span id="cb11-20"><a href="#cb11-20" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-21"><a href="#cb11-21" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-22"><a href="#cb11-22" aria-hidden="true" tabindex="-1"></a><span class="co"># Process each TIFF file</span></span>
<span id="cb11-23"><a href="#cb11-23" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> tiff_file <span class="kw">in</span> glob.glob(<span class="ss">f"</span><span class="sc">{</span>tiff_dir<span class="sc">}</span><span class="ss">/*.tif"</span>):</span>
<span id="cb11-24"><a href="#cb11-24" aria-hidden="true" tabindex="-1"></a>  exr_file <span class="op">=</span> os.path.join(exr_dir, os.path.basename(tiff_file).replace(<span class="st">".tif"</span>, <span class="st">".exr"</span>))</span>
<span id="cb11-25"><a href="#cb11-25" aria-hidden="true" tabindex="-1"></a>  run([</span>
<span id="cb11-26"><a href="#cb11-26" aria-hidden="true" tabindex="-1"></a>    <span class="st">"oiiotool"</span>, tiff_file,</span>
<span id="cb11-27"><a href="#cb11-27" aria-hidden="true" tabindex="-1"></a>    <span class="st">"--colorconfig"</span>, ocio_config,</span>
<span id="cb11-28"><a href="#cb11-28" aria-hidden="true" tabindex="-1"></a>    <span class="st">"--colorconvert"</span>, <span class="st">"srgb_display"</span>, <span class="st">"linear"</span>,</span>
<span id="cb11-29"><a href="#cb11-29" aria-hidden="true" tabindex="-1"></a>    <span class="st">"-d"</span>, <span class="st">"half"</span>,</span>
<span id="cb11-30"><a href="#cb11-30" aria-hidden="true" tabindex="-1"></a>    <span class="st">"-o"</span>, exr_file</span>
<span id="cb11-31"><a href="#cb11-31" aria-hidden="true" tabindex="-1"></a>  ])</span>
<span id="cb11-32"><a href="#cb11-32" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-33"><a href="#cb11-33" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"✅ TIFFs extracted and converted to EXR in "</span><span class="op">+</span>exr_dir)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>✅ TIFFs extracted and converted to EXR in exr_frames</code></pre>
</div>
</div>
</section>
<section id="compute-differences-export-heatmaps" class="level3">
<h3 class="anchored" data-anchor-id="compute-differences-export-heatmaps">🔎 Compute Differences &amp; Export Heatmaps</h3>
<p>OK - here’s the cool part. Let’s compute some differences, compute some heatmaps of the differences, etc.</p>
<p>First - a utility to compute some metrics via <code>colour-science</code>.</p>
<div id="32231f34" class="cell" data-execution_count="7">
<div class="sourceCode cell-code" id="cb13"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb13-1"><a href="#cb13-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> colour</span>
<span id="cb13-2"><a href="#cb13-2" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> colour.models <span class="im">import</span> RGB_to_XYZ, XYZ_to_Lab, RGB_COLOURSPACES</span>
<span id="cb13-3"><a href="#cb13-3" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> re</span>
<span id="cb13-4"><a href="#cb13-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-5"><a href="#cb13-5" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> compute_diff_metrics(diff_txt_path):</span>
<span id="cb13-6"><a href="#cb13-6" aria-hidden="true" tabindex="-1"></a>    <span class="im">import</span> re</span>
<span id="cb13-7"><a href="#cb13-7" aria-hidden="true" tabindex="-1"></a>    <span class="im">from</span> colour.models <span class="im">import</span> RGB_to_XYZ, XYZ_to_Lab, RGB_COLOURSPACES</span>
<span id="cb13-8"><a href="#cb13-8" aria-hidden="true" tabindex="-1"></a>    <span class="im">import</span> colour</span>
<span id="cb13-9"><a href="#cb13-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-10"><a href="#cb13-10" aria-hidden="true" tabindex="-1"></a>    <span class="cf">with</span> <span class="bu">open</span>(diff_txt_path, <span class="st">"r"</span>) <span class="im">as</span> f:</span>
<span id="cb13-11"><a href="#cb13-11" aria-hidden="true" tabindex="-1"></a>        lines <span class="op">=</span> f.readlines()</span>
<span id="cb13-12"><a href="#cb13-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-13"><a href="#cb13-13" aria-hidden="true" tabindex="-1"></a>    mean <span class="op">=</span> <span class="bu">float</span>([line <span class="cf">for</span> line <span class="kw">in</span> lines <span class="cf">if</span> <span class="st">"Mean error"</span> <span class="kw">in</span> line][<span class="dv">0</span>].split()[<span class="op">-</span><span class="dv">1</span>])</span>
<span id="cb13-14"><a href="#cb13-14" aria-hidden="true" tabindex="-1"></a>    rms <span class="op">=</span> <span class="bu">float</span>([line <span class="cf">for</span> line <span class="kw">in</span> lines <span class="cf">if</span> <span class="st">"RMS error"</span> <span class="kw">in</span> line][<span class="dv">0</span>].split()[<span class="op">-</span><span class="dv">1</span>])</span>
<span id="cb13-15"><a href="#cb13-15" aria-hidden="true" tabindex="-1"></a>    psnr <span class="op">=</span> <span class="bu">float</span>([line <span class="cf">for</span> line <span class="kw">in</span> lines <span class="cf">if</span> <span class="st">"Peak SNR"</span> <span class="kw">in</span> line][<span class="dv">0</span>].split()[<span class="op">-</span><span class="dv">1</span>])</span>
<span id="cb13-16"><a href="#cb13-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-17"><a href="#cb13-17" aria-hidden="true" tabindex="-1"></a>    max_error_line <span class="op">=</span> [line <span class="cf">for</span> line <span class="kw">in</span> lines <span class="cf">if</span> <span class="st">"Max error"</span> <span class="kw">in</span> line][<span class="dv">0</span>]</span>
<span id="cb13-18"><a href="#cb13-18" aria-hidden="true" tabindex="-1"></a>    match <span class="op">=</span> re.search(</span>
<span id="cb13-19"><a href="#cb13-19" aria-hidden="true" tabindex="-1"></a>        <span class="vs">r'Max error</span><span class="dv">\s</span><span class="op">*</span><span class="vs">=</span><span class="dv">\s</span><span class="op">*</span><span class="kw">(</span><span class="pp">[</span><span class="dv">\d</span><span class="pp">.]</span><span class="op">+</span><span class="kw">)</span><span class="dv">\s</span><span class="op">*</span><span class="vs">@</span><span class="dv">.</span><span class="op">*</span><span class="vs">values are </span><span class="kw">(</span><span class="pp">[</span><span class="dv">\d</span><span class="pp">., ]</span><span class="op">+</span><span class="kw">)</span><span class="vs"> vs </span><span class="kw">(</span><span class="pp">[</span><span class="dv">\d</span><span class="pp">., ]</span><span class="op">+</span><span class="kw">)</span><span class="vs">'</span>, max_error_line</span>
<span id="cb13-20"><a href="#cb13-20" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb13-21"><a href="#cb13-21" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-22"><a href="#cb13-22" aria-hidden="true" tabindex="-1"></a>    max_error <span class="op">=</span> <span class="bu">float</span>(match.group(<span class="dv">1</span>))</span>
<span id="cb13-23"><a href="#cb13-23" aria-hidden="true" tabindex="-1"></a>    orig_rgb <span class="op">=</span> [<span class="bu">float</span>(x.strip()) <span class="cf">for</span> x <span class="kw">in</span> match.group(<span class="dv">2</span>).split(<span class="st">','</span>)]</span>
<span id="cb13-24"><a href="#cb13-24" aria-hidden="true" tabindex="-1"></a>    roundtrip_rgb <span class="op">=</span> [<span class="bu">float</span>(x.strip()) <span class="cf">for</span> x <span class="kw">in</span> match.group(<span class="dv">3</span>).split(<span class="st">','</span>)]</span>
<span id="cb13-25"><a href="#cb13-25" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-26"><a href="#cb13-26" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Use BT.709 as the working colourspace</span></span>
<span id="cb13-27"><a href="#cb13-27" aria-hidden="true" tabindex="-1"></a>    colourspace <span class="op">=</span> RGB_COLOURSPACES[<span class="st">"ITU-R BT.709"</span>]</span>
<span id="cb13-28"><a href="#cb13-28" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-29"><a href="#cb13-29" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Convert RGB → XYZ → Lab</span></span>
<span id="cb13-30"><a href="#cb13-30" aria-hidden="true" tabindex="-1"></a>    orig_xyz <span class="op">=</span> RGB_to_XYZ(orig_rgb, colourspace)</span>
<span id="cb13-31"><a href="#cb13-31" aria-hidden="true" tabindex="-1"></a>    roundtrip_xyz <span class="op">=</span> RGB_to_XYZ(roundtrip_rgb, colourspace)</span>
<span id="cb13-32"><a href="#cb13-32" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-33"><a href="#cb13-33" aria-hidden="true" tabindex="-1"></a>    orig_lab <span class="op">=</span> XYZ_to_Lab(orig_xyz)</span>
<span id="cb13-34"><a href="#cb13-34" aria-hidden="true" tabindex="-1"></a>    roundtrip_lab <span class="op">=</span> XYZ_to_Lab(roundtrip_xyz)</span>
<span id="cb13-35"><a href="#cb13-35" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-36"><a href="#cb13-36" aria-hidden="true" tabindex="-1"></a>    delta_e <span class="op">=</span> colour.delta_E(orig_lab, roundtrip_lab, method<span class="op">=</span><span class="st">'CIE 1976'</span>)</span>
<span id="cb13-37"><a href="#cb13-37" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-38"><a href="#cb13-38" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> mean, rms, psnr, max_error, orig_rgb, roundtrip_rgb, delta_e</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Now, we iterate through the images, do the computations…</p>
<div id="ecad653b" class="cell" data-execution_count="8">
<div class="sourceCode cell-code" id="cb14"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb14-1"><a href="#cb14-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> pandas <span class="im">as</span> pd</span>
<span id="cb14-2"><a href="#cb14-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-3"><a href="#cb14-3" aria-hidden="true" tabindex="-1"></a><span class="co"># Define paths</span></span>
<span id="cb14-4"><a href="#cb14-4" aria-hidden="true" tabindex="-1"></a>diff_dir <span class="op">=</span> <span class="st">"diff_frames"</span></span>
<span id="cb14-5"><a href="#cb14-5" aria-hidden="true" tabindex="-1"></a>diff_data_dir <span class="op">=</span> <span class="st">"diff_data"</span></span>
<span id="cb14-6"><a href="#cb14-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-7"><a href="#cb14-7" aria-hidden="true" tabindex="-1"></a><span class="co"># Create directories for results</span></span>
<span id="cb14-8"><a href="#cb14-8" aria-hidden="true" tabindex="-1"></a>os.makedirs(diff_dir, exist_ok<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb14-9"><a href="#cb14-9" aria-hidden="true" tabindex="-1"></a>os.makedirs(diff_data_dir, exist_ok<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb14-10"><a href="#cb14-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-11"><a href="#cb14-11" aria-hidden="true" tabindex="-1"></a><span class="co"># Initialize a list to store diff metrics</span></span>
<span id="cb14-12"><a href="#cb14-12" aria-hidden="true" tabindex="-1"></a>diff_metrics <span class="op">=</span> []</span>
<span id="cb14-13"><a href="#cb14-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-14"><a href="#cb14-14" aria-hidden="true" tabindex="-1"></a><span class="co"># Process each frame</span></span>
<span id="cb14-15"><a href="#cb14-15" aria-hidden="true" tabindex="-1"></a>exr_files <span class="op">=</span> <span class="bu">sorted</span>(glob.glob(<span class="ss">f"</span><span class="sc">{</span>test_frames_dir<span class="sc">}</span><span class="ss">/frame_*.exr"</span>))</span>
<span id="cb14-16"><a href="#cb14-16" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> i, exr_path <span class="kw">in</span> <span class="bu">enumerate</span>(exr_files, start<span class="op">=</span><span class="dv">1</span>):</span>
<span id="cb14-17"><a href="#cb14-17" aria-hidden="true" tabindex="-1"></a>  frame_id <span class="op">=</span> <span class="ss">f"</span><span class="sc">{</span>i<span class="sc">:04d}</span><span class="ss">"</span></span>
<span id="cb14-18"><a href="#cb14-18" aria-hidden="true" tabindex="-1"></a>  original_frame <span class="op">=</span> os.path.join(test_frames_dir, <span class="ss">f"frame_</span><span class="sc">{</span>frame_id<span class="sc">}</span><span class="ss">.exr"</span>)</span>
<span id="cb14-19"><a href="#cb14-19" aria-hidden="true" tabindex="-1"></a>  roundtrip_frame <span class="op">=</span> os.path.join(exr_dir, <span class="ss">f"frame_</span><span class="sc">{</span>frame_id<span class="sc">}</span><span class="ss">.exr"</span>)</span>
<span id="cb14-20"><a href="#cb14-20" aria-hidden="true" tabindex="-1"></a>  diff_frame <span class="op">=</span> os.path.join(diff_dir, <span class="ss">f"frame_</span><span class="sc">{</span>frame_id<span class="sc">}</span><span class="ss">_diff.exr"</span>)</span>
<span id="cb14-21"><a href="#cb14-21" aria-hidden="true" tabindex="-1"></a>  diff_png <span class="op">=</span> os.path.join(diff_dir, <span class="ss">f"frame_</span><span class="sc">{</span>frame_id<span class="sc">}</span><span class="ss">_diff.png"</span>)</span>
<span id="cb14-22"><a href="#cb14-22" aria-hidden="true" tabindex="-1"></a>  tmp_diff_file <span class="op">=</span> os.path.join(diff_data_dir, <span class="ss">f"diff_</span><span class="sc">{</span>frame_id<span class="sc">}</span><span class="ss">.txt"</span>)</span>
<span id="cb14-23"><a href="#cb14-23" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb14-24"><a href="#cb14-24" aria-hidden="true" tabindex="-1"></a>  run([</span>
<span id="cb14-25"><a href="#cb14-25" aria-hidden="true" tabindex="-1"></a>      <span class="st">"oiiotool"</span>, original_frame, roundtrip_frame,</span>
<span id="cb14-26"><a href="#cb14-26" aria-hidden="true" tabindex="-1"></a>      <span class="st">"--diff"</span>, <span class="st">"--fail"</span>, <span class="st">"1e-06"</span>, <span class="st">"--hardfail"</span>, <span class="st">"1e-03"</span>,</span>
<span id="cb14-27"><a href="#cb14-27" aria-hidden="true" tabindex="-1"></a>      <span class="st">"-o"</span>, diff_frame</span>
<span id="cb14-28"><a href="#cb14-28" aria-hidden="true" tabindex="-1"></a>  ], stdout<span class="op">=</span><span class="bu">open</span>(tmp_diff_file, <span class="st">"w"</span>))</span>
<span id="cb14-29"><a href="#cb14-29" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-30"><a href="#cb14-30" aria-hidden="true" tabindex="-1"></a>  <span class="cf">with</span> <span class="bu">open</span>(tmp_diff_file, <span class="st">"r"</span>) <span class="im">as</span> f:</span>
<span id="cb14-31"><a href="#cb14-31" aria-hidden="true" tabindex="-1"></a>      diff_output <span class="op">=</span> f.read()</span>
<span id="cb14-32"><a href="#cb14-32" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-33"><a href="#cb14-33" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> <span class="st">"PASS"</span> <span class="kw">in</span> diff_output:</span>
<span id="cb14-34"><a href="#cb14-34" aria-hidden="true" tabindex="-1"></a>      <span class="co"># print(f"Frame {frame_id}: PASS (no significant differences)")</span></span>
<span id="cb14-35"><a href="#cb14-35" aria-hidden="true" tabindex="-1"></a>      mean <span class="op">=</span> rms <span class="op">=</span> psnr <span class="op">=</span> max_error <span class="op">=</span> delta_e <span class="op">=</span> <span class="st">"NA"</span></span>
<span id="cb14-36"><a href="#cb14-36" aria-hidden="true" tabindex="-1"></a>      orig_rgb <span class="op">=</span> roundtrip_rgb <span class="op">=</span> [<span class="st">"NA"</span>, <span class="st">"NA"</span>, <span class="st">"NA"</span>]</span>
<span id="cb14-37"><a href="#cb14-37" aria-hidden="true" tabindex="-1"></a>  <span class="cf">else</span>:</span>
<span id="cb14-38"><a href="#cb14-38" aria-hidden="true" tabindex="-1"></a>      mean, rms, psnr, max_error, orig_rgb, roundtrip_rgb, delta_e <span class="op">=</span> compute_diff_metrics(tmp_diff_file)</span>
<span id="cb14-39"><a href="#cb14-39" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-40"><a href="#cb14-40" aria-hidden="true" tabindex="-1"></a>  <span class="kw">def</span> format_metric(label, value):</span>
<span id="cb14-41"><a href="#cb14-41" aria-hidden="true" tabindex="-1"></a>      <span class="cf">if</span> <span class="bu">isinstance</span>(value, <span class="bu">float</span>):</span>
<span id="cb14-42"><a href="#cb14-42" aria-hidden="true" tabindex="-1"></a>          <span class="cf">return</span> <span class="ss">f"</span><span class="sc">{</span>label<span class="sc">:&lt;24}</span><span class="ss"> </span><span class="sc">{</span>value<span class="sc">:.6f}</span><span class="ss">"</span></span>
<span id="cb14-43"><a href="#cb14-43" aria-hidden="true" tabindex="-1"></a>      <span class="cf">else</span>:</span>
<span id="cb14-44"><a href="#cb14-44" aria-hidden="true" tabindex="-1"></a>          <span class="cf">return</span> <span class="ss">f"</span><span class="sc">{</span>label<span class="sc">:&lt;24}</span><span class="ss"> </span><span class="sc">{</span>value<span class="sc">}</span><span class="ss">"</span></span>
<span id="cb14-45"><a href="#cb14-45" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-46"><a href="#cb14-46" aria-hidden="true" tabindex="-1"></a>  <span class="co"># print(f"Frame {frame_id}:")</span></span>
<span id="cb14-47"><a href="#cb14-47" aria-hidden="true" tabindex="-1"></a>  <span class="co"># print(format_metric("Mean error:", mean))</span></span>
<span id="cb14-48"><a href="#cb14-48" aria-hidden="true" tabindex="-1"></a>  <span class="co"># print(format_metric("RMS error:", rms))</span></span>
<span id="cb14-49"><a href="#cb14-49" aria-hidden="true" tabindex="-1"></a>  <span class="co"># print(format_metric("PSNR:", psnr))</span></span>
<span id="cb14-50"><a href="#cb14-50" aria-hidden="true" tabindex="-1"></a>  <span class="co"># print(format_metric("Max error:", max_error))</span></span>
<span id="cb14-51"><a href="#cb14-51" aria-hidden="true" tabindex="-1"></a>  <span class="co"># print(format_metric("ΔE* (CIE76):", delta_e))</span></span>
<span id="cb14-52"><a href="#cb14-52" aria-hidden="true" tabindex="-1"></a>  <span class="co"># print(f"{'Original RGB:':&lt;24} {orig_rgb}")</span></span>
<span id="cb14-53"><a href="#cb14-53" aria-hidden="true" tabindex="-1"></a>  <span class="co"># print(f"{'Roundtripped RGB:':&lt;24} {roundtrip_rgb}")</span></span>
<span id="cb14-54"><a href="#cb14-54" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-55"><a href="#cb14-55" aria-hidden="true" tabindex="-1"></a>  diff_metrics.append({</span>
<span id="cb14-56"><a href="#cb14-56" aria-hidden="true" tabindex="-1"></a>      <span class="st">"frame"</span>: frame_id,</span>
<span id="cb14-57"><a href="#cb14-57" aria-hidden="true" tabindex="-1"></a>      <span class="st">"mean"</span>: mean,</span>
<span id="cb14-58"><a href="#cb14-58" aria-hidden="true" tabindex="-1"></a>      <span class="st">"rms"</span>: rms,</span>
<span id="cb14-59"><a href="#cb14-59" aria-hidden="true" tabindex="-1"></a>      <span class="st">"psnr"</span>: psnr,</span>
<span id="cb14-60"><a href="#cb14-60" aria-hidden="true" tabindex="-1"></a>      <span class="st">"max_error"</span>: max_error,</span>
<span id="cb14-61"><a href="#cb14-61" aria-hidden="true" tabindex="-1"></a>      <span class="st">"orig_r"</span>: orig_rgb[<span class="dv">0</span>],</span>
<span id="cb14-62"><a href="#cb14-62" aria-hidden="true" tabindex="-1"></a>      <span class="st">"orig_g"</span>: orig_rgb[<span class="dv">1</span>],</span>
<span id="cb14-63"><a href="#cb14-63" aria-hidden="true" tabindex="-1"></a>      <span class="st">"orig_b"</span>: orig_rgb[<span class="dv">2</span>],</span>
<span id="cb14-64"><a href="#cb14-64" aria-hidden="true" tabindex="-1"></a>      <span class="st">"roundtrip_r"</span>: roundtrip_rgb[<span class="dv">0</span>],</span>
<span id="cb14-65"><a href="#cb14-65" aria-hidden="true" tabindex="-1"></a>      <span class="st">"roundtrip_g"</span>: roundtrip_rgb[<span class="dv">1</span>],</span>
<span id="cb14-66"><a href="#cb14-66" aria-hidden="true" tabindex="-1"></a>      <span class="st">"roundtrip_b"</span>: roundtrip_rgb[<span class="dv">2</span>],</span>
<span id="cb14-67"><a href="#cb14-67" aria-hidden="true" tabindex="-1"></a>      <span class="st">"delta_e"</span>: delta_e</span>
<span id="cb14-68"><a href="#cb14-68" aria-hidden="true" tabindex="-1"></a>  })</span>
<span id="cb14-69"><a href="#cb14-69" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-70"><a href="#cb14-70" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Generate a heatmap for the difference</span></span>
<span id="cb14-71"><a href="#cb14-71" aria-hidden="true" tabindex="-1"></a>  run([</span>
<span id="cb14-72"><a href="#cb14-72" aria-hidden="true" tabindex="-1"></a>    <span class="st">"oiiotool"</span>, diff_frame,</span>
<span id="cb14-73"><a href="#cb14-73" aria-hidden="true" tabindex="-1"></a>    <span class="st">"--mulc"</span>, <span class="st">"50"</span>, <span class="st">"--clamp:low=0"</span>, <span class="st">"--clamp:high=1"</span>,</span>
<span id="cb14-74"><a href="#cb14-74" aria-hidden="true" tabindex="-1"></a>    <span class="st">"-o"</span>, diff_png</span>
<span id="cb14-75"><a href="#cb14-75" aria-hidden="true" tabindex="-1"></a>  ])</span>
<span id="cb14-76"><a href="#cb14-76" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-77"><a href="#cb14-77" aria-hidden="true" tabindex="-1"></a><span class="co"># Save the metrics to a CSV file</span></span>
<span id="cb14-78"><a href="#cb14-78" aria-hidden="true" tabindex="-1"></a>diff_metrics_df <span class="op">=</span> pd.DataFrame(diff_metrics)</span>
<span id="cb14-79"><a href="#cb14-79" aria-hidden="true" tabindex="-1"></a>diff_metrics_df.to_csv(diff_data_dir<span class="op">+</span><span class="ss">f"/diff_summary.csv"</span>, index<span class="op">=</span><span class="va">False</span>)</span>
<span id="cb14-80"><a href="#cb14-80" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"✅ Diff metrics and heatmaps generated successfully."</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>✅ Diff metrics and heatmaps generated successfully.</code></pre>
</div>
</div>
</section>
</section>
<section id="we-now-have-fully-traceable-artifacts-for-visual-and-statistical-inspection." class="level2">
<h2 class="anchored" data-anchor-id="we-now-have-fully-traceable-artifacts-for-visual-and-statistical-inspection.">We now have fully traceable artifacts for visual and statistical inspection.</h2>
</section>
<section id="diff-metrics-and-heatmaps" class="level2">
<h2 class="anchored" data-anchor-id="diff-metrics-and-heatmaps">🔎 Diff Metrics and Heatmaps</h2>
<p>Each original frame is compared to its roundtripped EXR using <code>oiiotool --diff</code>. Metrics are collected into a CSV for easy viewing:</p>
<div id="04e0cc02" class="cell" data-execution_count="9">
<div class="sourceCode cell-code" id="cb16"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb16-1"><a href="#cb16-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> pandas <span class="im">as</span> pd</span>
<span id="cb16-2"><a href="#cb16-2" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> matplotlib.pyplot <span class="im">as</span> plt</span>
<span id="cb16-3"><a href="#cb16-3" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> seaborn <span class="im">as</span> sns</span>
<span id="cb16-4"><a href="#cb16-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-5"><a href="#cb16-5" aria-hidden="true" tabindex="-1"></a>metrics <span class="op">=</span> pd.read_csv(<span class="st">"diff_data/diff_summary.csv"</span>)</span>
<span id="cb16-6"><a href="#cb16-6" aria-hidden="true" tabindex="-1"></a>metrics.set_index(<span class="st">"frame"</span>, inplace<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb16-7"><a href="#cb16-7" aria-hidden="true" tabindex="-1"></a>metrics[[<span class="st">"mean"</span>, <span class="st">"rms"</span>, <span class="st">"psnr"</span>, <span class="st">"max_error"</span>]]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="49">
<div>


<table class="dataframe caption-top table table-sm table-striped small" data-quarto-postprocess="true" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">mean</th>
<th data-quarto-table-cell-role="th">rms</th>
<th data-quarto-table-cell-role="th">psnr</th>
<th data-quarto-table-cell-role="th">max_error</th>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">frame</th>
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th"></th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td data-quarto-table-cell-role="th">1</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">2</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">3</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">4</td>
<td>0.000551</td>
<td>0.000679</td>
<td>63.3594</td>
<td>0.016846</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">5</td>
<td>0.000280</td>
<td>0.000334</td>
<td>69.5221</td>
<td>0.000858</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">6</td>
<td>0.000296</td>
<td>0.000357</td>
<td>68.9481</td>
<td>0.001063</td>
</tr>
</tbody>
</table>

</div>
</div>
</div>
<section id="error-vs-frame" class="level3">
<h3 class="anchored" data-anchor-id="error-vs-frame">📈 Error vs Frame</h3>
<div id="7415e4bc" class="cell" data-execution_count="10">
<div class="sourceCode cell-code" id="cb17"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb17-1"><a href="#cb17-1" aria-hidden="true" tabindex="-1"></a>metrics[[<span class="st">"rms"</span>, <span class="st">"max_error"</span>]].plot(kind<span class="op">=</span><span class="st">"bar"</span>, figsize<span class="op">=</span>(<span class="dv">10</span>, <span class="dv">5</span>), title<span class="op">=</span><span class="st">"Roundtrip Errors by Frame"</span>)</span>
<span id="cb17-2"><a href="#cb17-2" aria-hidden="true" tabindex="-1"></a>plt.ylabel(<span class="st">"Error"</span>)</span>
<span id="cb17-3"><a href="#cb17-3" aria-hidden="true" tabindex="-1"></a>plt.grid(<span class="va">True</span>)</span>
<span id="cb17-4"><a href="#cb17-4" aria-hidden="true" tabindex="-1"></a>plt.tight_layout()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="roundtrip_files/figure-html/cell-11-output-1.png" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
</div>
<hr>
</section>
</section>
<section id="visual-comparison" class="level2">
<h2 class="anchored" data-anchor-id="visual-comparison">🌈 Visual Comparison</h2>
<section id="difference-maps" class="level3">
<h3 class="anchored" data-anchor-id="difference-maps">🔥 Difference Maps</h3>
<p>You can inspect the absolute difference between original and roundtrip EXRs:</p>
<div class="columns">
<div class="column" style="width:50%;">
<p><img src="diff_frames/frame_0004_diff.png" class="img-fluid" style="width:100.0%" data-fig-cap="Quantized ramp error"></p>
</div><div class="column" style="width:50%;">
<p><img src="diff_frames/frame_0005_diff.png" class="img-fluid" style="width:100.0%" data-fig-cap="ColorChecker difference"></p>
</div>
</div>
<hr>
</section>
</section>
<section id="notes-for-students" class="level2">
<h2 class="anchored" data-anchor-id="notes-for-students">🧪 Notes for Students</h2>
<ul>
<li>The ProRes 4444 format retains more precision than standard 422, but still compresses chroma</li>
<li>ColorChecker conversion was done from Lab TIFF using ImageMagick (due to lack of Lab support in OCIO)</li>
<li>Linear ramps suffer most from quantization</li>
</ul>
<hr>
</section>
<section id="artifacts" class="level2">
<h2 class="anchored" data-anchor-id="artifacts">📁 Artifacts</h2>
<p>All generated files are available locally:</p>
<ul>
<li><code>test_frames/</code></li>
<li><code>tiff_frames/</code></li>
<li><code>exr_frames/</code></li>
<li><code>diff_frames/</code></li>
<li><code>diff_data/diff_summary.csv</code></li>
</ul>
<hr>
</section>
<section id="wrap-up" class="level2">
<h2 class="anchored" data-anchor-id="wrap-up">✅ Wrap-up</h2>
<p>This notebook supports understanding of:</p>
<ul>
<li>Visual error inspection in roundtrip workflows</li>
<li>Codec selection trade-offs</li>
<li>Role of OCIO and color conversion</li>
</ul>
<p>Let your students modify the test script, add other codecs, or introduce OCIO transforms to explore further.</p>
</section>


<div id="quarto-appendix" class="default"><section id="footnotes" class="footnotes footnotes-end-of-document" role="doc-endnotes"><h2 class="anchored quarto-appendix-heading">Footnotes</h2>

<ol>
<li id="fn1"><p>We have to use ImageMagick to convert from Lab to RGB because OCIO does not support Lab as a source color space. This is a limitation of the OCIO config we are using.<a href="#fnref1" class="footnote-back" role="doc-backlink">↩︎</a></p></li>
</ol>
</section></div></main>
<!-- /main column -->
<script id="quarto-html-after-body" type="application/javascript">
  window.document.addEventListener("DOMContentLoaded", function (event) {
    const icon = "";
    const anchorJS = new window.AnchorJS();
    anchorJS.options = {
      placement: 'right',
      icon: icon
    };
    anchorJS.add('.anchored');
    const isCodeAnnotation = (el) => {
      for (const clz of el.classList) {
        if (clz.startsWith('code-annotation-')) {                     
          return true;
        }
      }
      return false;
    }
    const onCopySuccess = function(e) {
      // button target
      const button = e.trigger;
      // don't keep focus
      button.blur();
      // flash "checked"
      button.classList.add('code-copy-button-checked');
      var currentTitle = button.getAttribute("title");
      button.setAttribute("title", "Copied!");
      let tooltip;
      if (window.bootstrap) {
        button.setAttribute("data-bs-toggle", "tooltip");
        button.setAttribute("data-bs-placement", "left");
        button.setAttribute("data-bs-title", "Copied!");
        tooltip = new bootstrap.Tooltip(button, 
          { trigger: "manual", 
            customClass: "code-copy-button-tooltip",
            offset: [0, -8]});
        tooltip.show();    
      }
      setTimeout(function() {
        if (tooltip) {
          tooltip.hide();
          button.removeAttribute("data-bs-title");
          button.removeAttribute("data-bs-toggle");
          button.removeAttribute("data-bs-placement");
        }
        button.setAttribute("title", currentTitle);
        button.classList.remove('code-copy-button-checked');
      }, 1000);
      // clear code selection
      e.clearSelection();
    }
    const getTextToCopy = function(trigger) {
        const codeEl = trigger.previousElementSibling.cloneNode(true);
        for (const childEl of codeEl.children) {
          if (isCodeAnnotation(childEl)) {
            childEl.remove();
          }
        }
        return codeEl.innerText;
    }
    const clipboard = new window.ClipboardJS('.code-copy-button:not([data-in-quarto-modal])', {
      text: getTextToCopy
    });
    clipboard.on('success', onCopySuccess);
    if (window.document.getElementById('quarto-embedded-source-code-modal')) {
      const clipboardModal = new window.ClipboardJS('.code-copy-button[data-in-quarto-modal]', {
        text: getTextToCopy,
        container: window.document.getElementById('quarto-embedded-source-code-modal')
      });
      clipboardModal.on('success', onCopySuccess);
    }
      var localhostRegex = new RegExp(/^(?:http|https):\/\/localhost\:?[0-9]*\//);
      var mailtoRegex = new RegExp(/^mailto:/);
        var filterRegex = new RegExp('/' + window.location.host + '/');
      var isInternal = (href) => {
          return filterRegex.test(href) || localhostRegex.test(href) || mailtoRegex.test(href);
      }
      // Inspect non-navigation links and adorn them if external
     var links = window.document.querySelectorAll('a[href]:not(.nav-link):not(.navbar-brand):not(.toc-action):not(.sidebar-link):not(.sidebar-item-toggle):not(.pagination-link):not(.no-external):not([aria-hidden]):not(.dropdown-item):not(.quarto-navigation-tool):not(.about-link)');
      for (var i=0; i<links.length; i++) {
        const link = links[i];
        if (!isInternal(link.href)) {
          // undo the damage that might have been done by quarto-nav.js in the case of
          // links that we want to consider external
          if (link.dataset.originalHref !== undefined) {
            link.href = link.dataset.originalHref;
          }
        }
      }
    function tippyHover(el, contentFn, onTriggerFn, onUntriggerFn) {
      const config = {
        allowHTML: true,
        maxWidth: 500,
        delay: 100,
        arrow: false,
        appendTo: function(el) {
            return el.parentElement;
        },
        interactive: true,
        interactiveBorder: 10,
        theme: 'quarto',
        placement: 'bottom-start',
      };
      if (contentFn) {
        config.content = contentFn;
      }
      if (onTriggerFn) {
        config.onTrigger = onTriggerFn;
      }
      if (onUntriggerFn) {
        config.onUntrigger = onUntriggerFn;
      }
      window.tippy(el, config); 
    }
    const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
    for (var i=0; i<noterefs.length; i++) {
      const ref = noterefs[i];
      tippyHover(ref, function() {
        // use id or data attribute instead here
        let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
        try { href = new URL(href).hash; } catch {}
        const id = href.replace(/^#\/?/, "");
        const note = window.document.getElementById(id);
        if (note) {
          return note.innerHTML;
        } else {
          return "";
        }
      });
    }
    const xrefs = window.document.querySelectorAll('a.quarto-xref');
    const processXRef = (id, note) => {
      // Strip column container classes
      const stripColumnClz = (el) => {
        el.classList.remove("page-full", "page-columns");
        if (el.children) {
          for (const child of el.children) {
            stripColumnClz(child);
          }
        }
      }
      stripColumnClz(note)
      if (id === null || id.startsWith('sec-')) {
        // Special case sections, only their first couple elements
        const container = document.createElement("div");
        if (note.children && note.children.length > 2) {
          container.appendChild(note.children[0].cloneNode(true));
          for (let i = 1; i < note.children.length; i++) {
            const child = note.children[i];
            if (child.tagName === "P" && child.innerText === "") {
              continue;
            } else {
              container.appendChild(child.cloneNode(true));
              break;
            }
          }
          if (window.Quarto?.typesetMath) {
            window.Quarto.typesetMath(container);
          }
          return container.innerHTML
        } else {
          if (window.Quarto?.typesetMath) {
            window.Quarto.typesetMath(note);
          }
          return note.innerHTML;
        }
      } else {
        // Remove any anchor links if they are present
        const anchorLink = note.querySelector('a.anchorjs-link');
        if (anchorLink) {
          anchorLink.remove();
        }
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(note);
        }
        if (note.classList.contains("callout")) {
          return note.outerHTML;
        } else {
          return note.innerHTML;
        }
      }
    }
    for (var i=0; i<xrefs.length; i++) {
      const xref = xrefs[i];
      tippyHover(xref, undefined, function(instance) {
        instance.disable();
        let url = xref.getAttribute('href');
        let hash = undefined; 
        if (url.startsWith('#')) {
          hash = url;
        } else {
          try { hash = new URL(url).hash; } catch {}
        }
        if (hash) {
          const id = hash.replace(/^#\/?/, "");
          const note = window.document.getElementById(id);
          if (note !== null) {
            try {
              const html = processXRef(id, note.cloneNode(true));
              instance.setContent(html);
            } finally {
              instance.enable();
              instance.show();
            }
          } else {
            // See if we can fetch this
            fetch(url.split('#')[0])
            .then(res => res.text())
            .then(html => {
              const parser = new DOMParser();
              const htmlDoc = parser.parseFromString(html, "text/html");
              const note = htmlDoc.getElementById(id);
              if (note !== null) {
                const html = processXRef(id, note);
                instance.setContent(html);
              } 
            }).finally(() => {
              instance.enable();
              instance.show();
            });
          }
        } else {
          // See if we can fetch a full url (with no hash to target)
          // This is a special case and we should probably do some content thinning / targeting
          fetch(url)
          .then(res => res.text())
          .then(html => {
            const parser = new DOMParser();
            const htmlDoc = parser.parseFromString(html, "text/html");
            const note = htmlDoc.querySelector('main.content');
            if (note !== null) {
              // This should only happen for chapter cross references
              // (since there is no id in the URL)
              // remove the first header
              if (note.children.length > 0 && note.children[0].tagName === "HEADER") {
                note.children[0].remove();
              }
              const html = processXRef(null, note);
              instance.setContent(html);
            } 
          }).finally(() => {
            instance.enable();
            instance.show();
          });
        }
      }, function(instance) {
      });
    }
        let selectedAnnoteEl;
        const selectorForAnnotation = ( cell, annotation) => {
          let cellAttr = 'data-code-cell="' + cell + '"';
          let lineAttr = 'data-code-annotation="' +  annotation + '"';
          const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
          return selector;
        }
        const selectCodeLines = (annoteEl) => {
          const doc = window.document;
          const targetCell = annoteEl.getAttribute("data-target-cell");
          const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
          const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
          const lines = annoteSpan.getAttribute("data-code-lines").split(",");
          const lineIds = lines.map((line) => {
            return targetCell + "-" + line;
          })
          let top = null;
          let height = null;
          let parent = null;
          if (lineIds.length > 0) {
              //compute the position of the single el (top and bottom and make a div)
              const el = window.document.getElementById(lineIds[0]);
              top = el.offsetTop;
              height = el.offsetHeight;
              parent = el.parentElement.parentElement;
            if (lineIds.length > 1) {
              const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
              const bottom = lastEl.offsetTop + lastEl.offsetHeight;
              height = bottom - top;
            }
            if (top !== null && height !== null && parent !== null) {
              // cook up a div (if necessary) and position it 
              let div = window.document.getElementById("code-annotation-line-highlight");
              if (div === null) {
                div = window.document.createElement("div");
                div.setAttribute("id", "code-annotation-line-highlight");
                div.style.position = 'absolute';
                parent.appendChild(div);
              }
              div.style.top = top - 2 + "px";
              div.style.height = height + 4 + "px";
              div.style.left = 0;
              let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
              if (gutterDiv === null) {
                gutterDiv = window.document.createElement("div");
                gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
                gutterDiv.style.position = 'absolute';
                const codeCell = window.document.getElementById(targetCell);
                const gutter = codeCell.querySelector('.code-annotation-gutter');
                gutter.appendChild(gutterDiv);
              }
              gutterDiv.style.top = top - 2 + "px";
              gutterDiv.style.height = height + 4 + "px";
            }
            selectedAnnoteEl = annoteEl;
          }
        };
        const unselectCodeLines = () => {
          const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
          elementsIds.forEach((elId) => {
            const div = window.document.getElementById(elId);
            if (div) {
              div.remove();
            }
          });
          selectedAnnoteEl = undefined;
        };
          // Handle positioning of the toggle
      window.addEventListener(
        "resize",
        throttle(() => {
          elRect = undefined;
          if (selectedAnnoteEl) {
            selectCodeLines(selectedAnnoteEl);
          }
        }, 10)
      );
      function throttle(fn, ms) {
      let throttle = false;
      let timer;
        return (...args) => {
          if(!throttle) { // first call gets through
              fn.apply(this, args);
              throttle = true;
          } else { // all the others get throttled
              if(timer) clearTimeout(timer); // cancel #2
              timer = setTimeout(() => {
                fn.apply(this, args);
                timer = throttle = false;
              }, ms);
          }
        };
      }
        // Attach click handler to the DT
        const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
        for (const annoteDlNode of annoteDls) {
          annoteDlNode.addEventListener('click', (event) => {
            const clickedEl = event.target;
            if (clickedEl !== selectedAnnoteEl) {
              unselectCodeLines();
              const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
              if (activeEl) {
                activeEl.classList.remove('code-annotation-active');
              }
              selectCodeLines(clickedEl);
              clickedEl.classList.add('code-annotation-active');
            } else {
              // Unselect the line
              unselectCodeLines();
              clickedEl.classList.remove('code-annotation-active');
            }
          });
        }
    const findCites = (el) => {
      const parentEl = el.parentElement;
      if (parentEl) {
        const cites = parentEl.dataset.cites;
        if (cites) {
          return {
            el,
            cites: cites.split(' ')
          };
        } else {
          return findCites(el.parentElement)
        }
      } else {
        return undefined;
      }
    };
    var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
    for (var i=0; i<bibliorefs.length; i++) {
      const ref = bibliorefs[i];
      const citeInfo = findCites(ref);
      if (citeInfo) {
        tippyHover(citeInfo.el, function() {
          var popup = window.document.createElement('div');
          citeInfo.cites.forEach(function(cite) {
            var citeDiv = window.document.createElement('div');
            citeDiv.classList.add('hanging-indent');
            citeDiv.classList.add('csl-entry');
            var biblioDiv = window.document.getElementById('ref-' + cite);
            if (biblioDiv) {
              citeDiv.innerHTML = biblioDiv.innerHTML;
            }
            popup.appendChild(citeDiv);
          });
          return popup.innerHTML;
        });
      }
    }
  });
  </script>
</div> <!-- /content -->




</body></html>